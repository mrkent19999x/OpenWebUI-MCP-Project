version: '3.8'

services:
  # OpenWebUI Service - MERGED: OpenWebUI-MCP-Project + Openwwebui (MiniMax)
  # Config hiện tại của anh: OLLAMA_BASE_URL, WEBUI_URL, WEBUI_NAME
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: always
    ports:
      - "7860:8080"  # Port hiện tại của anh
    volumes:
      # Mount ổ 500GB của anh (giữ nguyên data)
      - /home/mrkent/openwebui-storage/openwebui-data:/app/backend/data
      # Enhanced GUI Files (Manus AI-like)
      - ./custom-theme.css:/app/frontend/public/custom-theme.css:ro
      - ./hide-terminal-theme.css:/app/frontend/public/hide-terminal-theme.css:ro
      - ./workspace-config.json:/app/backend/data/workspace-config.json:ro
      - ./quick-actions.json:/app/backend/data/quick-actions.json:ro
      - ./code-preview-component.js:/app/frontend/public/code-preview-component.js:ro
      - ./ui-optimization-config.json:/app/backend/data/ui-optimization-config.json:ro
      - ./prompt-templates.json:/app/backend/data/prompt-templates.json:ro
      - ./system-prompts.json:/app/backend/data/system-prompts.json:ro
    environment:
      # Application Settings - Config của anh
      - WEBUI_URL=${WEBUI_URL:-http://192.168.1.176:7860}
      - WEBUI_NAME=${WEBUI_NAME:-Open WebUI - 24/7}
      - PORT=8080
      - ENV=${ENV:-prod}
      
      # Authentication & Security
      - WEBUI_AUTH=${WEBUI_AUTH:-False}
      - WEBUI_SECRET_KEY=${WEBUI_SECRET_KEY:-t0p-s3cr3t}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-4w}
      - ENABLE_SIGNUP=${ENABLE_SIGNUP:-True}
      - ENABLE_PERSISTENT_CONFIG=${ENABLE_PERSISTENT_CONFIG:-True}
      - DEFAULT_USER_ROLE=${DEFAULT_USER_ROLE:-pending}
      
      # Vietnamese Language Support
      - DEFAULT_LOCALE=${DEFAULT_LOCALE:-vi}
      - ENABLE_LOGIN_FORM=${ENABLE_LOGIN_FORM:-True}
      
      # Session Management
      - WEBUI_SESSION_COOKIE_SAME_SITE=${WEBUI_SESSION_COOKIE_SAME_SITE:-lax}
      - WEBUI_AUTH_COOKIE_SAME_SITE=${WEBUI_AUTH_COOKIE_SAME_SITE:-lax}
      
      # CORS Configuration
      - CORS_ALLOW_ORIGIN=${CORS_ALLOW_ORIGIN:-*}
      
      # Ollama Configuration - External Ollama của anh
      - ENABLE_OLLAMA_API=${ENABLE_OLLAMA_API:-True}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      - USE_OLLAMA_DOCKER=${USE_OLLAMA_DOCKER:-false}
      
      # MiniMax Configuration
      - MINIMAX_API_BASE_URL=${MINIMAX_API_BASE_URL:-https://api.minimax.chat/v1}
      - ENABLE_MINIMAX=${ENABLE_MINIMAX:-True}
      - MINIMAX_SANDBOX_ENABLED=${MINIMAX_SANDBOX_ENABLED:-False}
      - MINIMAX_SANDBOX_API_URL=${MINIMAX_SANDBOX_API_URL:-https://api.minimax.chat/v1/sandbox}
      
      # File Upload
      - ENABLE_FILE_UPLOAD=${ENABLE_FILE_UPLOAD:-True}
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-104857600}
      - ALLOWED_FILE_EXTENSIONS=${ALLOWED_FILE_EXTENSIONS:-.txt,.pdf,.doc,.docx,.xls,.xlsx,.csv,.json,.md,.py,.js,.html,.css}
      
      # Image Upload & Vision
      - ENABLE_IMAGE_UPLOAD=${ENABLE_IMAGE_UPLOAD:-True}
      - MAX_IMAGE_SIZE=${MAX_IMAGE_SIZE:-10485760}
      - ALLOWED_IMAGE_EXTENSIONS=${ALLOWED_IMAGE_EXTENSIONS:-.jpg,.jpeg,.png,.gif,.webp}
      
      # Knowledge Base & RAG
      - ENABLE_KNOWLEDGE_BASE=${ENABLE_KNOWLEDGE_BASE:-True}
      - ENABLE_RAG=${ENABLE_RAG:-True}
      - VECTOR_DB=${VECTOR_DB:-chroma}
      
      # Agents & Tools
      - ENABLE_AGENTS=${ENABLE_AGENTS:-True}
      - ENABLE_TOOLS=${ENABLE_TOOLS:-True}
      
      # Code Execution
      - ENABLE_CODE_EXECUTION=${ENABLE_CODE_EXECUTION:-True}
      - JUPYTER_URL=${JUPYTER_URL:-http://jupyter:8888}
      - JUPYTER_TOKEN=${JUPYTER_TOKEN:-manus-code-sandbox-2024}
      - CODE_EXECUTOR_URL=${CODE_EXECUTOR_URL:-http://code-executor:3001}
      
      # Web Browser
      - ENABLE_WEB_BROWSER=${ENABLE_WEB_BROWSER:-True}
      - BROWSER_AUTOMATION_URL=${BROWSER_AUTOMATION_URL:-http://browser-automation:4444}
      
      # Database (Để trống để dùng SQLite mặc định, hoặc set DATABASE_URL nếu dùng PostgreSQL)
      # - DATABASE_URL=${DATABASE_URL:-}
      
      # Redis
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
    depends_on:
      - redis
      - jupyter
      - browser-automation
      - code-executor
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - openwebui-network

  # Jupyter Lab - Code Execution Environment
  jupyter:
    image: jupyter/minimal-notebook:latest
    container_name: jupyter-sandbox
    restart: always
    ports:
      - "8888:8888"
    volumes:
      - jupyter-notebooks:/home/jovyan/work
      - code-executions:/home/jovyan/executions
    environment:
      - JUPYTER_ENABLE_LAB=yes
      - JUPYTER_TOKEN=${JUPYTER_TOKEN:-manus-code-sandbox-2024}
      - CHOWN_HOME=yes
      - CHOWN_HOME_OPTS=-R
    networks:
      - openwebui-network

  # Browser Automation Service (Selenium + Playwright)
  browser-automation:
    image: seleniarm/standalone-chromium:latest
    container_name: browser-automation
    restart: always
    ports:
      - "4444:4444"  # Selenium WebDriver
      - "7900:7900"  # VNC for debugging
    volumes:
      - browser-screenshots:/screenshots
      - browser-data:/home/selenium/Downloads
    environment:
      - VNC_NO_PASSWORD=1
      - VNC_PASSWORD=secret
      - SCREEN_WIDTH=1920
      - SCREEN_HEIGHT=1080
      - DISPLAY=:99
    networks:
      - openwebui-network

  # Code Execution Service (Node.js + Python runtime)
  code-executor:
    image: node:18-alpine
    container_name: code-executor
    restart: always
    ports:
      - "3001:3001"
    volumes:
      - code-workspace:/workspace
      - code-outputs:/outputs
      - ./code-executor:/app
    environment:
      - NODE_ENV=production
      - WORKSPACE_PATH=/workspace
      - OUTPUT_PATH=/outputs
    working_dir: /app
    command: >
      sh -c "
        apk add --no-cache python3 py3-pip &&
        pip3 install --break-system-packages requests beautifulsoup4 pandas numpy &&
        npm install &&
        node server.js
      "
    networks:
      - openwebui-network

  # PostgreSQL Database (Optional - cho LiteLLM hoặc metadata)
  postgres:
    image: postgres:15-alpine
    container_name: postgres
    restart: always
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-openwebui}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-password}
    networks:
      - openwebui-network

  # Redis Cache & WebSocket
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: always
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
      - ./redis.conf:/etc/redis/redis.conf:ro
    command: redis-server /etc/redis/redis.conf
    networks:
      - openwebui-network

  # Nginx Load Balancer & Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx-ssl:/etc/nginx/ssl:ro
    depends_on:
      - open-webui
    networks:
      - openwebui-network

  # MCP Tools Server (GitHub, Docker, etc.)
  mcp-server:
    image: python:3.11-slim
    container_name: mcp-server
    restart: always
    ports:
      - "3003:3003"
    volumes:
      - mcp-workspace:/workspace
      - ./mcp-server:/app:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - MCP_SERVER_PORT=3003
      - GITHUB_TOKEN=${GITHUB_TOKEN:-placeholder}
      - DOCKER_SOCKET=/var/run/docker.sock
    working_dir: /app
    command: >
      sh -c "
        pip install fastapi uvicorn github3.py docker &&
        python mcp_server.py
      "
    networks:
      - openwebui-network

  # Multi-Agent Orchestrator (từ Openwwebui) - ĐÃ TẮT
  # orchestrator:
  #   image: python:3.11-slim
  #   container_name: orchestrator
  #   restart: always
  #   ports:
  #     - "8000:8000"
  #   volumes:
  #     - ./orchestrator/src:/app/src:ro
  #   environment:
  #     - ORCHESTRATOR_PORT=8000
  #     - OLLAMA_BASE_URL=http://host.docker.internal:11434
  #     - MINIMAX_API_KEY=${MINIMAX_API_KEY:-}
  #     - GMAIL_USER=${GMAIL_USER:-}
  #     - GMAIL_APP_PASSWORD=${GMAIL_APP_PASSWORD:-}
  #     - GITHUB_TOKEN=${GITHUB_TOKEN:-}
  #     - PERPLEXITY_API_KEY=${PERPLEXITY_API_KEY:-}
  #     - GEMINI_API_KEY=${GEMINI_API_KEY:-}
  #     - ZALO_OA_ACCESS_TOKEN=${ZALO_OA_ACCESS_TOKEN:-}
  #     - ZALO_OA_SECRET_KEY=${ZALO_OA_SECRET_KEY:-}
  #   working_dir: /app/src
  #   command: >
  #     sh -c "
  #       pip install fastapi uvicorn &&
  #       python main.py
  #     "
  #   networks:
  #     - openwebui-network
  #   extra_hosts:
  #     - "host.docker.internal:host-gateway"
  #   healthcheck:
  #     test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

volumes:
  litellm_logs:
    driver: local
  litellm_cache:
    driver: local
  postgres-data:
    driver: local
  redis-data:
    driver: local
  jupyter-notebooks:
    driver: local
  code-executions:
    driver: local
  browser-screenshots:
    driver: local
  browser-data:
    driver: local
  code-workspace:
    driver: local
  code-outputs:
    driver: local
  deployment-workspace:
    driver: local
  mcp-workspace:
    driver: local

networks:
  openwebui-network:
    driver: bridge

