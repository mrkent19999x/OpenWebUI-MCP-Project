version: '3.8'

services:
  # OpenWebUI Main Service - Optimized Version
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: unless-stopped
    ports:
      - "${PORT:-7860}:8080"
    volumes:
      # Data persistence
      - openwebui-data:/app/backend/data
      - openwebui-cache:/app/backend/cache
      
      # Enhanced GUI Files (Manus AI-like features)
      - ./custom-theme.css:/app/frontend/public/custom-theme.css:ro
      - ./hide-terminal-theme.css:/app/frontend/public/hide-terminal-theme.css:ro
      - ./workspace-config.json:/app/backend/data/workspace-config.json:ro
      - ./quick-actions.json:/app/backend/data/quick-actions.json:ro
      - ./code-preview-component.js:/app/frontend/public/code-preview-component.js:ro
      - ./ui-optimization-config.json:/app/backend/data/ui-optimization-config.json:ro
      - ./prompt-templates.json:/app/backend/data/prompt-templates.json:ro
      - ./system-prompts.json:/app/backend/data/system-prompts.json:ro
      
      # Configuration files (Organized structure)
      - ./config/prompts:/app/backend/data/prompts:ro
      - ./config/cursor:/app/backend/data/cursor:ro
      - ./config/ui:/app/backend/data/ui:ro
    environment:
      # Application settings
      - WEBUI_URL=${WEBUI_URL:-http://localhost:7860}
      - WEBUI_NAME=${WEBUI_NAME:-Open WebUI - Manus AI Equivalent}
      - ENV=${ENV:-production}
      - PORT=8080
      
      # API Keys
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - MINIMAX_API_KEY=${MINIMAX_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      
      # Vietnamese Language Support
      - DEFAULT_LOCALE=${DEFAULT_LOCALE:-vi}
      - ENABLE_LOGIN_FORM=${ENABLE_LOGIN_FORM:-True}
      
      # Security & Authentication
      - WEBUI_SECRET_KEY=${WEBUI_SECRET_KEY}
      - WEBUI_AUTH=${WEBUI_AUTH:-False}
      - ENABLE_SIGNUP=${ENABLE_SIGNUP:-True}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-4w}
      
      # Database (SQLite default, PostgreSQL optional)
      - DATABASE_URL=${DATABASE_URL:-sqlite:///./openwebui.db}
      
      # Performance & Limits
      - MAX_WORKERS=${MAX_WORKERS:-4}
      - TIMEOUT=${TIMEOUT:-300}
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-104857600}
      - CACHE_SIZE=${CACHE_SIZE:-1GB}
      - MAX_IMAGE_SIZE=${MAX_IMAGE_SIZE:-10485760}
      
      # Features
      - ENABLE_OLLAMA=${ENABLE_OLLAMA:-True}
      - ENABLE_BROWSER=${ENABLE_WEB_BROWSER:-True}
      - ENABLE_CODE_EXECUTION=${ENABLE_CODE_EXECUTION:-True}
      - HIDE_TERMINAL_BY_DEFAULT=${HIDE_TERMINAL_BY_DEFAULT:-True}
      
      # File Upload & Management
      - ENABLE_FILE_UPLOAD=${ENABLE_FILE_UPLOAD:-True}
      - ENABLE_IMAGE_UPLOAD=${ENABLE_IMAGE_UPLOAD:-True}
      - ALLOWED_FILE_EXTENSIONS=${ALLOWED_FILE_EXTENSIONS:-.txt,.pdf,.doc,.docx,.xls,.xlsx,.csv,.json,.md,.py,.js,.html,.css}
      - ALLOWED_IMAGE_EXTENSIONS=${ALLOWED_IMAGE_EXTENSIONS:-.jpg,.jpeg,.png,.gif,.webp}
      
      # Knowledge Base & RAG
      - ENABLE_KNOWLEDGE_BASE=${ENABLE_KNOWLEDGE_BASE:-True}
      - ENABLE_RAG=${ENABLE_RAG:-True}
      - VECTOR_DB=${VECTOR_DB:-chroma}
      
      # Agents & Tools
      - ENABLE_AGENTS=${ENABLE_AGENTS:-True}
      - ENABLE_TOOLS=${ENABLE_TOOLS:-True}
      
      # Session Management
      - WEBUI_SESSION_COOKIE_SAME_SITE=${WEBUI_SESSION_COOKIE_SAME_SITE:-lax}
      - WEBUI_AUTH_COOKIE_SAME_SITE=${WEBUI_AUTH_COOKIE_SAME_SITE:-lax}
      
      # CORS Configuration
      - CORS_ALLOW_ORIGIN=${CORS_ALLOW_ORIGIN:-*}
      
      # Ollama Configuration
      - ENABLE_OLLAMA_API=${ENABLE_OLLAMA_API:-True}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      - USE_OLLAMA_DOCKER=${USE_OLLAMA_DOCKER:-false}
      
      # MiniMax Configuration
      - MINIMAX_API_BASE_URL=${MINIMAX_API_BASE_URL:-https://api.minimax.chat/v1}
      - ENABLE_MINIMAX=${ENABLE_MINIMAX:-True}
      - MINIMAX_SANDBOX_ENABLED=${MINIMAX_SANDBOX_ENABLED:-False}
      
      # Code Execution Integration
      - JUPYTER_URL=${JUPYTER_URL:-http://jupyter:8888}
      - JUPYTER_TOKEN=${JUPYTER_TOKEN:-manus-code-sandbox-2024}
      - CODE_EXECUTOR_URL=${CODE_EXECUTOR_URL:-http://code-executor:3001}
      
      # Web Browser Integration
      - BROWSER_AUTOMATION_URL=${BROWSER_AUTOMATION_URL:-http://browser-automation:4444}
      
      # Redis Configuration
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      
      # Multi-agent settings
      - AGENT_TIMEOUT=${AGENT_TIMEOUT:-60}
      - MAX_CONCURRENT_AGENTS=${MAX_CONCURRENT_AGENTS:-8}
      - AGENT_POOL_SIZE=${AGENT_POOL_SIZE:-16}
      
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - AUDIT_LOGGING=${AUDIT_LOGGING:-True}
    deploy:
      resources:
        limits:
          memory: ${MEMORY_LIMIT:-4g}
          cpus: ${CPU_LIMIT:-2.0}
        reservations:
          memory: 2g
          cpus: 1.0
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - openwebui-network
    depends_on:
      - redis
      - jupyter
      - browser-automation
      - code-executor
      - mcp-server

  # Jupyter Lab - Code Execution Environment
  jupyter:
    image: jupyter/minimal-notebook:latest
    container_name: jupyter-sandbox
    restart: unless-stopped
    ports:
      - "8888:8888"
    volumes:
      - jupyter-notebooks:/home/jovyan/work
      - code-executions:/home/jovyan/executions
    environment:
      - JUPYTER_ENABLE_LAB=yes
      - JUPYTER_TOKEN=${JUPYTER_TOKEN:-manus-code-sandbox-2024}
      - CHOWN_HOME=yes
      - CHOWN_HOME_OPTS=-R
    networks:
      - openwebui-network

  # Browser Automation Service (Selenium + Playwright)
  browser-automation:
    image: seleniarm/standalone-chromium:latest
    container_name: browser-automation
    restart: unless-stopped
    ports:
      - "4444:4444"  # Selenium WebDriver
      - "7900:7900"  # VNC for debugging
    volumes:
      - browser-screenshots:/screenshots
      - browser-data:/home/selenium/Downloads
    environment:
      - VNC_NO_PASSWORD=1
      - VNC_PASSWORD=secret
      - SCREEN_WIDTH=1920
      - SCREEN_HEIGHT=1080
      - DISPLAY=:99
    networks:
      - openwebui-network

  # Code Execution Service (Node.js + Python runtime)
  code-executor:
    image: node:18-alpine
    container_name: code-executor
    restart: unless-stopped
    ports:
      - "3001:3001"
    volumes:
      - code-workspace:/workspace
      - code-outputs:/outputs
      - ./code-executor:/app
    environment:
      - NODE_ENV=production
      - WORKSPACE_PATH=/workspace
      - OUTPUT_PATH=/outputs
    working_dir: /app
    command: >
      sh -c "
        apk add --no-cache python3 py3-pip curl &&
        pip3 install --break-system-packages requests beautifulsoup4 pandas numpy matplotlib seaborn &&
        npm install &&
        node server.js
      "
    networks:
      - openwebui-network

  # MCP Tools Server (GitHub, Docker, etc.)
  mcp-server:
    image: python:3.11-slim
    container_name: mcp-server
    restart: unless-stopped
    ports:
      - "3003:3003"
    volumes:
      - mcp-workspace:/workspace
      - ./mcp-server:/app:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - MCP_SERVER_PORT=3003
      - GITHUB_TOKEN=${GITHUB_TOKEN:-placeholder}
      - DOCKER_SOCKET=/var/run/docker.sock
    working_dir: /app
    command: >
      sh -c "
        pip install --break-system-packages fastapi uvicorn github3.py docker requests &&
        python mcp_server.py
      "
    networks:
      - openwebui-network

  # PostgreSQL Database (Optional)
  postgres:
    image: postgres:15-alpine
    container_name: postgres
    restart: unless-stopped
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-openwebui}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-password}
    networks:
      - openwebui-network
    profiles:
      - production

  # Redis Cache & WebSocket
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    networks:
      - openwebui-network

  # ChromaDB Vector Database (Optional)
  chromadb:
    image: chromadb/chroma:latest
    container_name: chromadb
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - CHROMA_SERVER_AUTHN_CREDENTIALS=admin:admin
      - CHROMA_SERVER_AUTHN_PROVIDER=chromadb.auth.basic.BasicAuthenticationServerProvider
    volumes:
      - chromadb-data:/chroma/chroma
    networks:
      - openwebui-network
    profiles:
      - production

  # Ollama (Local AI Models)
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    deploy:
      resources:
        limits:
          memory: 8g
          cpus: 4.0
    networks:
      - openwebui-network
    profiles:
      - local-models

  # Nginx Load Balancer & Reverse Proxy (Optional)
  nginx:
    image: nginx:alpine
    container_name: nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx-ssl:/etc/nginx/ssl:ro
    depends_on:
      - open-webui
    networks:
      - openwebui-network
    profiles:
      - production

  # Ngrok Tunnel (For remote access)
  ngrok:
    image: ngrok/ngrok:latest
    container_name: ngrok
    restart: unless-stopped
    environment:
      - NGROK_AUTH_TOKEN=${NGROK_AUTH_TOKEN}
      - NGROK_REGION=${NGROK_REGION:-us}
    command: ["http", "open-webui:8080", "--domain=${NGROK_DOMAIN:-your-domain.ngrok.io}"]
    depends_on:
      - open-webui
    networks:
      - openwebui-network
    profiles:
      - remote-access

  # Multi-Agent Orchestrator (Optional - tạm thời tắt)
  # orchestrator:
  #   image: python:3.11-slim
  #   container_name: orchestrator
  #   restart: unless-stopped
  #   ports:
  #     - "8000:8000"
  #   volumes:
  #     - ./orchestrator/src:/app/src:ro
  #   environment:
  #     - ORCHESTRATOR_PORT=8000
  #     - OLLAMA_BASE_URL=http://host.docker.internal:11434
  #     - MINIMAX_API_KEY=${MINIMAX_API_KEY:-}
  #     - GMAIL_USER=${GMAIL_USER:-}
  #     - GMAIL_APP_PASSWORD=${GMAIL_APP_PASSWORD:-}
  #     - GITHUB_TOKEN=${GITHUB_TOKEN:-}
  #     - PERPLEXITY_API_KEY=${PERPLEXITY_API_KEY:-}
  #     - GEMINI_API_KEY=${GEMINI_API_KEY:-}
  #     - ZALO_OA_ACCESS_TOKEN=${ZALO_OA_ACCESS_TOKEN:-}
  #     - ZALO_OA_SECRET_KEY=${ZALO_OA_SECRET_KEY:-}
  #   working_dir: /app/src
  #   command: >
  #     sh -c "
  #       pip install --break-system-packages fastapi uvicorn &&
  #       python main.py
  #     "
  #   networks:
  #     - openwebui-network
  #   extra_hosts:
  #     - "host.docker.internal:host-gateway"
  #   healthcheck:
  #     test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

volumes:
  openwebui-data:
    driver: local
  openwebui-cache:
    driver: local
  postgres-data:
    driver: local
  redis-data:
    driver: local
  chromadb-data:
    driver: local
  ollama-data:
    driver: local
  jupyter-notebooks:
    driver: local
  code-executions:
    driver: local
  browser-screenshots:
    driver: local
  browser-data:
    driver: local
  code-workspace:
    driver: local
  code-outputs:
    driver: local
  deployment-workspace:
    driver: local
  mcp-workspace:
    driver: local

networks:
  openwebui-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16