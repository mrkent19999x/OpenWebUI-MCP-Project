version: '3.8'

services:
  # Open WebUI Service
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: always
    ports:
      - "${WEBUI_PORT:-3000}:8080"
    volumes:
      - open-webui-data:/app/backend/data
    environment:
      # Application Settings
      - WEBUI_URL=${WEBUI_URL:-http://localhost:3000}
      - WEBUI_NAME=${WEBUI_NAME:-Open WebUI}
      - PORT=8080
      - ENV=${ENV:-prod}
      
      # Authentication & Security
      - WEBUI_AUTH=${WEBUI_AUTH:-True}
      - WEBUI_SECRET_KEY=${WEBUI_SECRET_KEY:-t0p-s3cr3t}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-4w}
      - ENABLE_SIGNUP=${ENABLE_SIGNUP:-True}
      - ENABLE_PERSISTENT_CONFIG=${ENABLE_PERSISTENT_CONFIG:-True}
      - DEFAULT_USER_ROLE=${DEFAULT_USER_ROLE:-pending}
      
      # Vietnamese Language Support
      - DEFAULT_LOCALE=${DEFAULT_LOCALE:-vi}
      - ENABLE_LOGIN_FORM=${ENABLE_LOGIN_FORM:-True}
      
      # Session Management
      - WEBUI_SESSION_COOKIE_SAME_SITE=${WEBUI_SESSION_COOKIE_SAME_SITE:-lax}
      - WEBUI_AUTH_COOKIE_SAME_SITE=${WEBUI_AUTH_COOKIE_SAME_SITE:-lax}
      
      # CORS Configuration
      - CORS_ALLOW_ORIGIN=${CORS_ALLOW_ORIGIN:-*}
      
      # Ollama Configuration
      - ENABLE_OLLAMA_API=${ENABLE_OLLAMA_API:-True}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://ollama:11434}
      - OLLAMA_BASE_URLS=${OLLAMA_BASE_URLS}
      
      # OpenAI Configuration
      - ENABLE_OPENAI_API=${ENABLE_OPENAI_API:-True}
      - OPENAI_API_BASE_URL=${OPENAI_API_BASE_URL:-https://api.openai.com/v1}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - TASK_MODEL=${TASK_MODEL}
      - TASK_MODEL_EXTERNAL=${TASK_MODEL_EXTERNAL}
      
      # MiniMax Configuration (OpenAI-Compatible)
      - MINIMAX_API_KEY=${MINIMAX_API_KEY}
      - MINIMAX_API_BASE_URL=${MINIMAX_API_BASE_URL:-https://api.minimax.chat/v1}
      - ENABLE_MINIMAX=${ENABLE_MINIMAX:-True}
      - MINIMAX_SANDBOX_ENABLED=${MINIMAX_SANDBOX_ENABLED:-False}
      - MINIMAX_SANDBOX_API_URL=${MINIMAX_SANDBOX_API_URL:-https://api.minimax.chat/v1/sandbox}
      
      # MCP (Model Context Protocol) Configuration
      - ENABLE_DIRECT_CONNECTIONS=${ENABLE_DIRECT_CONNECTIONS:-True}
      - TOOL_SERVER_CONNECTIONS=${TOOL_SERVER_CONNECTIONS}
      
      # Performance Settings - REALTIME
      - ENABLE_REALTIME_CHAT_SAVE=${ENABLE_REALTIME_CHAT_SAVE:-False}
      - CHAT_RESPONSE_STREAM_DELTA_CHUNK_SIZE=${CHAT_RESPONSE_STREAM_DELTA_CHUNK_SIZE:-1}
      - THREAD_POOL_SIZE=${THREAD_POOL_SIZE:-0}
      - MODELS_CACHE_TTL=${MODELS_CACHE_TTL:-1}
      
      # Timeout Settings
      - AIOHTTP_CLIENT_TIMEOUT=${AIOHTTP_CLIENT_TIMEOUT:-300}
      - AIOHTTP_CLIENT_TIMEOUT_MODEL_LIST=${AIOHTTP_CLIENT_TIMEOUT_MODEL_LIST:-10}
      
      # WebSocket & Redis (for realtime features)
      - ENABLE_WEBSOCKET_SUPPORT=${ENABLE_WEBSOCKET_SUPPORT:-False}
      
      # Vector Database
      - VECTOR_DB=${VECTOR_DB:-chroma}
      - CHROMA_TENANT=${CHROMA_TENANT:-default_tenant}
      - CHROMA_DATABASE=${CHROMA_DATABASE:-default_database}
      
      # RAG Settings
      - ENABLE_RAG_WEB_SEARCH=${ENABLE_RAG_WEB_SEARCH:-True}
      - ENABLE_WEB_LOADER_SSL_VERIFICATION=${ENABLE_WEB_LOADER_SSL_VERIFICATION:-True}
      
      # Features
      - ENABLE_TITLE_GENERATION=${ENABLE_TITLE_GENERATION:-True}
      - ENABLE_FOLLOW_UP_GENERATION=${ENABLE_FOLLOW_UP_GENERATION:-True}
      - ENABLE_MESSAGE_RATING=${ENABLE_MESSAGE_RATING:-True}
      - ENABLE_COMMUNITY_SHARING=${ENABLE_COMMUNITY_SHARING:-True}
      
      # Admin Settings
      - ENABLE_ADMIN_EXPORT=${ENABLE_ADMIN_EXPORT:-True}
      - ENABLE_ADMIN_CHAT_ACCESS=${ENABLE_ADMIN_CHAT_ACCESS:-True}
      - SHOW_ADMIN_DETAILS=${SHOW_ADMIN_DETAILS:-True}
      
      # OAuth 2.1 Enhancements (v0.6.35-v0.6.36)
      - OAUTH_GROUPS_SEPARATOR=${OAUTH_GROUPS_SEPARATOR:-;}
      - OAUTH_ROLES_SEPARATOR=${OAUTH_ROLES_SEPARATOR:-,}
      - ENABLE_OAUTH_WITHOUT_EMAIL=${ENABLE_OAUTH_WITHOUT_EMAIL:-False}
      - ENABLE_STAR_SESSIONS_MIDDLEWARE=${ENABLE_STAR_SESSIONS_MIDDLEWARE:-True}
      
      # Image Generation System (v0.6.35)
      - ENABLE_IMAGE_GENERATION=${ENABLE_IMAGE_GENERATION:-True}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_API_BASE_URL=${GEMINI_API_BASE_URL:-https://generativelanguage.googleapis.com/v1beta}
      - ENABLE_GEMINI_2_5_FLASH_IMAGE=${ENABLE_GEMINI_2_5_FLASH_IMAGE:-True}
      - ENABLE_QWEN_IMAGE_EDIT=${ENABLE_QWEN_IMAGE_EDIT:-True}
      - AUTOMATIC1111_API_URL=${AUTOMATIC1111_API_URL}
      - ENABLE_AUTOMATIC1111_JSON_PARAMS=${ENABLE_AUTOMATIC1111_JSON_PARAMS:-True}
      
      # Audio/TTS System (v0.6.35)
      - ELEVENLABS_API_BASE_URL=${ELEVENLABS_API_BASE_URL:-https://api.elevenlabs.io/v1}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - MISTRAL_OCR_API_BASE_URL=${MISTRAL_OCR_API_BASE_URL:-https://api.mistral.ai/v1}
      - MISTRAL_API_KEY=${MISTRAL_API_KEY}
      - ENABLE_MISTRAL_VOXTRAL_TTS=${ENABLE_MISTRAL_VOXTRAL_TTS:-True}
      - VOXTRAL_MODEL=${VOXTRAL_MODEL:-voxtral-small}
      - ENABLE_GLOBAL_AUDIO_QUEUE=${ENABLE_GLOBAL_AUDIO_QUEUE:-True}
      - ENABLE_TTS_STOP_CONTROL=${ENABLE_TTS_STOP_CONTROL:-True}
      
      # MinerU Document Processing (v0.6.34)
      - ENABLE_MINERU=${ENABLE_MINERU:-False}
      - MINERU_API_URL=${MINERU_API_URL:-http://mineru:8000}
      - MINERU_API_KEY=${MINERU_API_KEY}
      
      # External Document Loaders (v0.6.35)
      - ENABLE_FORWARD_USER_INFO_HEADERS=${ENABLE_FORWARD_USER_INFO_HEADERS:-True}
      
      # Progressive Web App (v0.6.33)
      - ENABLE_PROGRESSIVE_WEB_APP=${ENABLE_PROGRESSIVE_WEB_APP:-True}
      - ENABLE_PWA_ANDROID_SHARE_TARGET=${ENABLE_PWA_ANDROID_SHARE_TARGET:-True}
      
      # Data Directory
      - DATA_DIR=/app/backend/data
      
    networks:
      - open-webui-network
    depends_on:
      - ollama
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Ollama Service (optional, remove if using external Ollama)
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: always
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    volumes:
      - ollama-data:/root/.ollama
    networks:
      - open-webui-network
    # Uncomment for GPU support (NVIDIA)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]

  # Redis Service (optional, for WebSocket load balancing)
  redis:
    image: redis:7-alpine
    container_name: open-webui-redis
    restart: always
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    networks:
      - open-webui-network
    command: redis-server --appendonly yes
    profiles:
      - with-redis

  # ChromaDB Service (optional, for external vector DB)
  chromadb:
    image: chromadb/chroma:latest
    container_name: chromadb
    restart: always
    ports:
      - "${CHROMA_PORT:-8000}:8000"
    volumes:
      - chromadb-data:/chroma/chroma
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=${CHROMA_TELEMETRY:-True}
    networks:
      - open-webui-network
    profiles:
      - with-chromadb

volumes:
  open-webui-data:
    driver: local
  ollama-data:
    driver: local
  redis-data:
    driver: local
  chromadb-data:
    driver: local

networks:
  open-webui-network:
    driver: bridge
